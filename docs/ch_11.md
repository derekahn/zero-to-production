# Chapter 11 - Fault-Tolerant Workflows

> We want our application to be fault-tolerant.

Newsletter delivery should not be disrupted by:

- transient failures; like application crashes
- Postmark API errors or network timeouts.

**Concepts:**

- [ ] idempotency
- [ ] locking
- [ ] queues
- [ ] background jobs

## Idempotency: An Introduction

**retry-safety** is defined as:

> An API endpoint is retry-safe (or **idempotent**) if the caller has no way to **observe**
> if a request has been sent to the server once or multiple times.

**retry-safety** and **idempotency** are often used interchangeably when speaking to various people in the tech world.

## Implementation Strategies

- State**ful** Idempotency: Save And Replay
  - Store a unique key per HTTP request. Perform a lookup for a matching key in the store for each request
  - This approach could cause _timing_ issues where new subscribers would miss out on receiving the newsletter, who just subscribed during the exact same time the retry was submitted.
- State**less** Idempotency: Deterministic Key Generation
  - Leverage Postmark API and generate a unique key from the subscriber ID for each call to PostMark.
  - Unfortunately Postmark API doesn't provide an idempotency mechanism.

## Schema

Since we're going to use Postgres as a data store to track our Idempotent keys, we'll be storing the following:

- user id
  - A composite primary key
  - Also recoded when each row was created for easy eviction of stale rows.
- idempotency key
  - A composite primary key
  - Also recoded when each row was created for easy eviction of stale rows.
- HTTP response
  - Could use type _bytea_ but it'd be tricky to re-hydrate bytes into an `HttpResponse` object
  - Since the target is `HTTP/1.1` we'll use the type `smallint` for the status code

```sql
CREATE TYPE header_pair AS (
    name TEXT,
    value BYTEA
);

CREATE TABLE idempotency (
    user_id uuid NOT NULL REFERENCES users(user_id),
    idempotency_key TEXT NOT NULL,
    response_status_code SMALLINT NOT NULL,
    response_headers header_pair[] NOT NULL,
    response_body BYTEA NOT NULL,
    created_at timestamptz NOT NULL,
    PRIMARY KEY(user_id, idempotency_key)
);
```

## References

- [postmark batch-emails](https://postmarkapp.com/developer/user-guide/send-email-with-api/batch-emails)
- [bug in sqlx](https://github.com/launchbadge/sqlx/issues/1031)
- [bug in the Rust compiler](https://github.com/rust-lang/rust/issues/82219)
